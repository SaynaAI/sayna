# GitHub Actions workflow for manual version management using release-plz
# Manually trigger to create release PRs with specified version bump.
#
# Workflow:
# 1. Manually trigger with version bump type -> release-plz creates Release PR
# 2. Merge Release PR -> release-plz creates Git tag
# 3. Tag creation -> triggers release.yml workflow

name: Release-plz

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  pull_request:
    types:
      - closed
    branches:
      - master

# Permissions required for creating branches, commits, tags, and PRs
permissions:
  contents: write
  pull-requests: write

jobs:
  # =============================================================================
  # Job 1: Create Release PR with manual version bump
  # =============================================================================
  release-plz:
    name: Release PR (${{ github.event.inputs.bump }})
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Calculate new version
        id: version
        run: |
          # Get current version from Cargo.toml
          current=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $current"

          # Parse version components
          IFS='.' read -r major minor patch <<< "$current"

          # Bump based on input
          case "${{ github.event.inputs.bump }}" in
            major)
              new_version="$((major + 1)).0.0"
              ;;
            minor)
              new_version="${major}.$((minor + 1)).0"
              ;;
            patch)
              new_version="${major}.${minor}.$((patch + 1))"
              ;;
          esac

          echo "New version: $new_version"
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"

      - name: Update version in Cargo.toml
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.new_version }}"/' Cargo.toml
          echo "Updated Cargo.toml to version ${{ steps.version.outputs.new_version }}"
          grep '^version = ' Cargo.toml

      - name: Run release-plz
        uses: release-plz/action@v0.5
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Job 2: Create Git tag when Release PR is merged
  # =============================================================================
  release-plz-tag:
    name: Create Tag
    # Only run when a PR is merged (not just closed)
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release-plz-')
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          # Note: Using GITHUB_TOKEN here. Tags created with GITHUB_TOKEN
          # will NOT trigger other workflows (like release.yml).
          # If automatic release triggering is desired, use a Personal Access Token:
          # token: ${{ secrets.RELEASE_PAT }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz release
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag creation summary
        run: |
          echo "## Release Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release-plz PR has been merged and a new version tag has been created." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Tags created with GITHUB_TOKEN do not trigger other workflows automatically." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To trigger the release build, either:" >> $GITHUB_STEP_SUMMARY
          echo "1. Manually trigger the Release workflow from the Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure a Personal Access Token (PAT) for automatic triggering" >> $GITHUB_STEP_SUMMARY
